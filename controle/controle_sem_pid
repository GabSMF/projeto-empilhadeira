#include <Arduino.h>

// --- PINOS MOTORES DE TRAÇÃO ---
// Motor 1 (Esquerdo)
#define PINO_IN1 22
#define PINO_IN2 23
#define PINO_PWM 18

// Motor 2 (Direito)
#define PINO_IN3 19
#define PINO_IN4 21
#define PINO_PWM2 17

// --- PINOS MOTOR LIFT (EMPILHADEIRA) ---
#define PINO_IN5 33 // Controle sentido A (Lift)
#define PINO_IN6 32 // Controle sentido B (Lift)
#define PINO_PWM_LIFT 4 // Velocidade (Lift)

// Variáveis globais
char comandoAtual = 'P'; // Começa Parado
int velocidadeAtual = 0;

void setup(){ 
  Serial.begin(115200); 

  // Configura Tração
  pinMode(PINO_IN1, OUTPUT);
  pinMode(PINO_IN2, OUTPUT);
  pinMode(PINO_PWM, OUTPUT);
  
  pinMode(PINO_IN3, OUTPUT);
  pinMode(PINO_IN4, OUTPUT);
  pinMode(PINO_PWM2, OUTPUT);

  // Configura Lift
  pinMode(PINO_IN5, OUTPUT);
  pinMode(PINO_IN6, OUTPUT);
  pinMode(PINO_PWM_LIFT, OUTPUT);

  pararTudo();

  Serial.println("--- Sistema Pronto (Com Lift) ---");
  Serial.println("Comandos Rodas: F, B, L, R (Ex: F200)");
  Serial.println("Comandos Lift: U (Subir), D (Descer) (Ex: U255)");
  Serial.println("Parar Geral: P ou S");
}
  
void loop() {   
  if (Serial.available() > 0) {
    
    char leitura = Serial.read(); 

    // Filtro de ruído (Enter)
    if (leitura == '\n' || leitura == '\r') {
      return; 
    }

    comandoAtual = leitura;
    
    // Tenta ler a velocidade (se não vier numero, retorna 0)
    int novaVelocidade = Serial.parseInt(); 
    
    // Atualiza velocidade se foi enviado um valor maior que 0
    // Isso permite enviar apenas "F" para repetir a ultima velocidade se quiser,
    // mas idealmente envie sempre "F200", "U200", etc.
    if (novaVelocidade > 0) {
      velocidadeAtual = novaVelocidade;
    }
    
    // Trava de segurança PWM
    if (velocidadeAtual > 255) velocidadeAtual = 255;
    if (velocidadeAtual < 0) velocidadeAtual = 0;

    executarComando();
  }
}

void executarComando() {
  switch (comandoAtual) {
    // --- COMANDOS DE TRAÇÃO ---
    case 'F': // FRENTE
      pararLift(); // Garante que o lift pare
      moverFrente(velocidadeAtual);
      Serial.println("RODAS: Frente");
      break;
      
    case 'B': // RÉ
      pararLift();
      moverTras(velocidadeAtual);
      Serial.println("RODAS: Tras");
      break;
      
    case 'L': // ESQUERDA
      pararLift();
      virarEsquerda(velocidadeAtual);
      Serial.println("RODAS: Esq");
      break;
      
    case 'R': // DIREITA
      pararLift();
      virarDireita(velocidadeAtual);
      Serial.println("RODAS: Dir");
      break;

    // --- COMANDOS DO LIFT ---
    case 'U': // UP (SUBIR)
      pararRodas(); // Garante que o carro pare
      moverLiftCima(velocidadeAtual);
      Serial.println("LIFT: Subindo");
      break;

    case 'D': // DOWN (DESCER)
      pararRodas();
      moverLiftBaixo(velocidadeAtual);
      Serial.println("LIFT: Descendo");
      break;

    // --- COMANDO DE PARADA ---
    case 'S': 
    case 'P': 
      Serial.println("PARADA TOTAL");
      pararTudo();
      velocidadeAtual = 0;
      break;
      
    default:
      // Comando desconhecido, ignora.
      break;
  }
}

// ==========================================
// --- FUNÇÕES AUXILIARES ---
// ==========================================

// --- Funções das Rodas ---
void moverFrente(int pwm) {
  digitalWrite(PINO_IN1, HIGH); digitalWrite(PINO_IN2, LOW); analogWrite(PINO_PWM, pwm);
  digitalWrite(PINO_IN3, LOW); digitalWrite(PINO_IN4, HIGH); analogWrite(PINO_PWM2, pwm);
}

void moverTras(int pwm) {
  digitalWrite(PINO_IN1, LOW); digitalWrite(PINO_IN2, HIGH); analogWrite(PINO_PWM, pwm);
  digitalWrite(PINO_IN3, HIGH); digitalWrite(PINO_IN4, LOW); analogWrite(PINO_PWM2, pwm);
}

void virarEsquerda(int pwm) {
  digitalWrite(PINO_IN1, LOW); digitalWrite(PINO_IN2, HIGH); analogWrite(PINO_PWM, pwm);
  digitalWrite(PINO_IN3, LOW); digitalWrite(PINO_IN4, HIGH); analogWrite(PINO_PWM2, pwm);
}

void virarDireita(int pwm) {
  digitalWrite(PINO_IN1, HIGH); digitalWrite(PINO_IN2, LOW); analogWrite(PINO_PWM, pwm);
  digitalWrite(PINO_IN3, HIGH); digitalWrite(PINO_IN4, LOW); analogWrite(PINO_PWM2, pwm);
}

void pararRodas() {
  digitalWrite(PINO_IN1, LOW); digitalWrite(PINO_IN2, LOW); analogWrite(PINO_PWM, 0);
  digitalWrite(PINO_IN3, LOW); digitalWrite(PINO_IN4, LOW); analogWrite(PINO_PWM2, 0);
}

// --- Funções do Lift ---
void moverLiftCima(int pwm) {
  digitalWrite(PINO_IN5, HIGH); 
  digitalWrite(PINO_IN6, LOW); 
  analogWrite(PINO_PWM_LIFT, pwm);
}

void moverLiftBaixo(int pwm) {
  digitalWrite(PINO_IN5, LOW); 
  digitalWrite(PINO_IN6, HIGH); 
  analogWrite(PINO_PWM_LIFT, pwm);
}

void pararLift() {
  digitalWrite(PINO_IN5, LOW); 
  digitalWrite(PINO_IN6, LOW); 
  analogWrite(PINO_PWM_LIFT, 0);
}

// --- Parada Geral ---
void pararTudo() {
  pararRodas();
  pararLift();
}
